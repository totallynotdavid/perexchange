name: test

on:
  push:
    branches: ["main"]
    paths: ["**/*.py"]
  pull_request:
    paths: ["**/*.py"]
  schedule:
    - cron: "0 3 * * 1" # Every Monday at 03:00 UTC
  workflow_dispatch:

jobs:
  unit:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-python@v6
        with:
          python-version: "3.14.0"

      - run: |
          pip install -r pkg/core/requirements.txt
          pip install -e .[dev]

      - run:
          pytest -v -m "not integration" --cov=perexchange --cov-report=xml
          --junitxml=junit.xml

      - uses: codecov/codecov-action@5a1091511ad55cbe89839c7260b706298ca349f7 #v5.5.1
        with:
          files: ./coverage.xml
          report_type: coverage

      - uses: codecov/codecov-action@5a1091511ad55cbe89839c7260b706298ca349f7 #v5.5.1
        with:
          files: ./junit.xml
          report_type: test_results

  integration:
    runs-on: ubuntu-latest
    if:
      github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' ||
      github.ref == 'refs/heads/main'

    permissions:
      issues: write

    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-python@v6
        with:
          python-version: "3.14.0"

      - run: |
          pip install -r pkg/core/requirements.txt
          pip install -e .[dev]

      - id: test
        run: pytest -v -m integration --tb=short
        continue-on-error: true

      - if:
          failure() && steps.test.outcome == 'failure' && (github.event_name == 'schedule'
          || github.event_name == 'workflow_dispatch')
        uses: actions/github-script@v8
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'integration-test-failure'
            });

            const body = `Run: \`pytest -m integration\`\n\n${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'fix: integration tests failing',
                body: body,
                labels: ['integration-test-failure', 'bug']
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: body
              });
            }
